stages:
  - test
  - push
  - publish
variables:
  GIT_STRATEGY: clone
services:
  - manticoresearch/manticore

.init_sqls: &init_sqls
  - curl -X POST http://manticoresearch-manticore:9308/sql -d "mode=raw&query=CREATE TABLE test(content text, name text attribute, cat integer)"
  - curl -X POST http://manticoresearch-manticore:9308/sql -d "mode=raw&query=CREATE TABLE test_pq(content text, name text attribute, cat integer) type='pq'"  

python_testing:
  image: python
  stage: test
  only:
    changes:
      - out/manticoresearch-python/**/*
  before_script:
    - *init_sqls
  script:
    - cd out/manticoresearch-python
    - pip install -r requirements.txt
    - python setup.py install
    - python test/test.py

javascript_testing:
  image: node
  stage: test
  only:
    changes:
      - out/manticoresearch-javascript/**/*
  before_script:
    - *init_sqls      
  script:
    - cd out/manticoresearch-javascript
    - npm install --only=dev
    - npm install inherits
    - npm test

java_testing:
  image: maven
  stage: test
  only:
    changes:
      - out/manticoresearch-java/**/*
  before_script:
    - *init_sqls
  script:
    - cd out/manticoresearch-java
    - mvn test

python_push:
  stage: push
  before_script:
    - apt-get update && apt-get install -y git
  only:
    changes:
      - out/manticoresearch-python/**/*    
  script:
    - git subtree push --prefix=out/manticoresearch-python https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com/manticoresoftware/manticoresearch-python.git master
  dependencies:
    - python_testing

javascript_push:
  stage: push
  before_script:
    - apt-get update && apt-get install -y git
  only:
    changes:
      - out/manticoresearch-javascript/**/*
  script:
    - git subtree push --prefix=out/manticoresearch-javascript https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com/manticoresoftware/manticoresearch-javascript.git master
  dependencies:
    - javascript_testing

java_push:
  stage: push
  before_script:
    - apt-get update && apt-get install -y git
  only:
    changes:
      - out/manticoresearch-java/**/*
  script:
    - git subtree push --prefix=out/manticoresearch-java https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com/manticoresoftware/manticoresearch-java.git master
  dependencies:
    - java_testing
    
javascript_npmjs:
  stage: publish
  when: manual
  image: node
  allow_failure: true
  script:
    - cp $NPMRC  ~/.npmrc
    - cd out/manticoresearch-javascript
    - npm publish

python_pypi:
  stage: publish
  image: python
  when: manual
  allow_failure: true
  script:
    - cd out/manticoresearch-python
    - cp $PYPIRC  ~/.pypirc
    - python -m pip install --user --upgrade twine
    - python setup.py sdist bdist_wheel
    - python -m twine upload dist/*
    
  