stages:
  - push
  - publish
variables:
  GIT_STRATEGY: clone
services:
  - manticoresearch/manticore

.init_sqls: &init_sqls
  - curl -X POST http://manticoresearch-manticore:9308/sql -d "mode=raw&query=CREATE TABLE test(content text, name text attribute, cat integer)"
  - curl -X POST http://manticoresearch-manticore:9308/sql -d "mode=raw&query=CREATE TABLE test_pq(content text, name text attribute, cat integer) type=\'pq\'"  

typescript_push:
  image: ubuntu:latest
  stage: push
  before_script:
    - apt-get update && apt-get install -y git
  only:
    changes:
      - out/manticoresearch-typescript/**/*
  script:
    - git remote add manticoresearch-typescript https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com/manticoresoftware/manticoresearch-typescript.git
    - git fetch manticoresearch-typescript
    - git subtree push --prefix=out/manticoresearch-typescript https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com/manticoresoftware/manticoresearch-typescript.git $CI_COMMIT_BRANCH
    
typescript_npmjs:
  stage: publish
  when: manual
  image: node
  allow_failure: true
  script:
    - cp $NPMRC  ~/.npmrc
    - npm install -g typescript 
    - cd out/manticoresearch-typescript
    - npm install --save-dev chai
    - npm install --save-dev @types/node
    - npm publish

